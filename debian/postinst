#!/bin/bash
# postinst script for bosh-agent
# Written by Miriam Espa√±a Acebal <miriam.espana@canonical.com>, November 2021.  Public Domain.
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

assets_dir="" #to be determined
bosh_app_dir=/var/vcap
bosh_dir="${bosh_app_dir}"/bosh
monit_dir="${bosh_app_dir}"/monit

case "$1" in
    configure)

    # Checking that all the needed folder exists
    if [ ! -d "/etc/sv" ]; then
        mkdir -p /etc/sv
    fi

    if [ ! -d "/etc/sv/agent" ]; then
        mkdir -p /etc/sv/agent
    fi

    if [ ! -d "${bosh_app_dir}/monit" ]; then
        mkdir -p "${bosh_app_dir}"/monit
    fi

    if [ ! -d "${monit_dir}/svlog" ]; then
        mkdir -p "${monit_dir}"/svlog
    fi

    # Putting files in place or creating them
    cp -a "${assets_dir}"/nats-access-helper.sh "${bosh_dir}"/etc/nats-access-helper.sh
    cp -a "${assets_dir}"/02-restrict-nats-api-access-allow-monit-api /etc/network/if-up.d/02-restrict-nats-api-access-allow-monit-api
    cp -a "${assets_dir}"/runit/agent /etc/sv/agent
    cp -a "${assets_dir}"/runit/monit /etc/sv/monit

    if [ ! -s "${monit_dir}"/empty.monitrc ]; then
        touch "${monit_dir}"/monit/empty.monitrc
    fi

    if [ -e "/etc/service/agent" ];then
        rm -f /etc/service/agent
    fi
    ln -s /etc/sv/agent /etc/service/agent

    if [ -e "/etc/service/monit" ];then
        rm -f /etc/service/monit
    fi
    ln -s /etc/sv/monit /etc/service/monit

    # Adapting permissions
    chmod +x "${bosh_dir}"/etc/nats-access-helper.sh /etc/network/if-up.d/02-restrict-nats-api-access-allow-monit-api
    chmod +x /etc/sv/agent/run /etc/sv/agent/log/run
    chmod +x /etc/sv/monit/run /etc/sv/monit/log/run

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
